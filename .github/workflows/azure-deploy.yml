name: Deploy RushMore Pizza to Azure

on:
  push:
    branches: 
      - main  # Deploy when code is pushed/merged to main
      - feature/local-fastapi-docker-setup  # Keep feature branch for testing
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  AZURE_RESOURCE_GROUP: rg-rushmorepizza-prod
  AZURE_LOCATION: uksouth
  POSTGRES_ADMIN_USER: rushmoreadmin
  PYTHON_VERSION: '3.11'

jobs:
  provision-infrastructure:
    runs-on: ubuntu-latest
    environment: production  # Add environment protection
    outputs:
      webAppName: ${{ steps.deploy.outputs.webAppName }}
      postgresServer: ${{ steps.deploy.outputs.postgresServerFqdn }}
      keyVaultName: ${{ steps.deploy.outputs.keyVaultName }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }} \
          --tags Environment=Production Project=RushmorePizza DeployedFrom=GitHub

    - name: Deploy Bicep template
      id: deploy
      uses: azure/arm-deploy@v1
      with:
        resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
        template: ./infrastructure/azure-resources.bicep
        parameters: >
          projectName=rushmorepizza
          environment=prod
          location=${{ env.AZURE_LOCATION }}
          adminUsername=${{ env.POSTGRES_ADMIN_USER }}
          adminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        deploymentName: rushmorepizza-${{ github.run_number }}
        failOnStdErr: false

    - name: Output deployment info
      run: |
        echo "::notice::PostgreSQL Server: ${{ steps.deploy.outputs.postgresServerFqdn }}"
        echo "::notice::Web App URL: ${{ steps.deploy.outputs.webAppUrl }}"
        echo "::notice::Key Vault: ${{ steps.deploy.outputs.keyVaultName }}"

  deploy-database-schema:
    needs: provision-infrastructure
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-client

    - name: Wait for PostgreSQL to be ready
      run: |
        echo "Waiting for PostgreSQL server to be ready..."
        sleep 60

    - name: Deploy database schema
      env:
        PGHOST: ${{ needs.provision-infrastructure.outputs.postgresServer }}
        PGPORT: 5432
        PGDATABASE: rushmore_db
        PGUSER: ${{ env.POSTGRES_ADMIN_USER }}
        PGPASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        PGSSLMODE: require
      run: |
        echo "Deploying schema to $PGHOST..."
        psql -f create_tables.sql -v ON_ERROR_STOP=1
      continue-on-error: false

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Populate database with test data
      env:
        DB_HOST: ${{ needs.provision-infrastructure.outputs.postgresServer }}
        DB_PORT: 5432
        DB_NAME: rushmore_db
        DB_USER: ${{ env.POSTGRES_ADMIN_USER }}
        DB_PASSWORD: ${{ secrets.POSTGRES_ADMIN_PASSWORD }}
        SSL_MODE: require
      run: |
        echo "Populating database with Faker data..."
        python populate.py

  deploy-application:
    needs: [provision-infrastructure, deploy-database-schema]
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create startup command
      run: |
        echo "gunicorn app.main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --timeout 120 --access-logfile '-' --error-logfile '-'" > startup.txt

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get Key Vault secrets
      id: getSecrets
      run: |
        DB_PASSWORD=$(az keyvault secret show --vault-name ${{ needs.provision-infrastructure.outputs.keyVaultName }} --name db-password --query value -o tsv)
        echo "::add-mask::$DB_PASSWORD"
        echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_OUTPUT

    - name: Configure Web App settings
      run: |
        az webapp config appsettings set \
          --name ${{ needs.provision-infrastructure.outputs.webAppName }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --settings \
            DB_HOST="${{ needs.provision-infrastructure.outputs.postgresServer }}" \
            DB_PORT="5432" \
            DB_NAME="rushmore_db" \
            DB_USER="${{ env.POSTGRES_ADMIN_USER }}" \
            SSL_MODE="require" \
            WEBSITES_PORT="8000" \
            SCM_DO_BUILD_DURING_DEPLOYMENT="true" \
            PYTHON_VERSION="${{ env.PYTHON_VERSION }}"

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ needs.provision-infrastructure.outputs.webAppName }}
        package: .
        startup-command: 'gunicorn app.main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --timeout 120'

    - name: Wait for deployment
      run: sleep 30

    - name: Health check
      run: |
        WEBAPP_URL="https://${{ needs.provision-infrastructure.outputs.webAppName }}.azurewebsites.net"
        echo "Testing health endpoint: ${WEBAPP_URL}/health"
        
        for i in {1..10}; do
          if curl -f -s "${WEBAPP_URL}/health"; then
            echo "::notice::Health check passed!"
            exit 0
          fi
          echo "Attempt $i failed, retrying in 10 seconds..."
          sleep 10
        done
        
        echo "::error::Health check failed after 10 attempts"
        exit 1

    - name: Test API endpoints
      run: |
        WEBAPP_URL="https://${{ needs.provision-infrastructure.outputs.webAppName }}.azurewebsites.net"
        
        echo "Testing /menu endpoint..."
        curl -f -s "${WEBAPP_URL}/menu" > /dev/null && echo "âœ“ Menu endpoint OK" || echo "âœ— Menu endpoint failed"
        
        echo "Testing /stores endpoint..."
        curl -f -s "${WEBAPP_URL}/stores" > /dev/null && echo "âœ“ Stores endpoint OK" || echo "âœ— Stores endpoint failed"
        
        echo "::notice::Deployment complete! API available at: ${WEBAPP_URL}/docs"

  notify-completion:
    needs: [provision-infrastructure, deploy-application]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**API URL:** https://${{ needs.provision-infrastructure.outputs.webAppName }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        echo "**API Docs:** https://${{ needs.provision-infrastructure.outputs.webAppName }}.azurewebsites.net/docs" >> $GITHUB_STEP_SUMMARY
        echo "**PostgreSQL:** ${{ needs.provision-infrastructure.outputs.postgresServer }}" >> $GITHUB_STEP_SUMMARY
        echo "**Key Vault:** ${{ needs.provision-infrastructure.outputs.keyVaultName }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- Health: \`GET /health\`" >> $GITHUB_STEP_SUMMARY
        echo "- Menu: \`GET /menu\`" >> $GITHUB_STEP_SUMMARY
        echo "- Stores: \`GET /stores\`" >> $GITHUB_STEP_SUMMARY
        echo "- Orders: \`POST /orders\`" >> $GITHUB_STEP_SUMMARY